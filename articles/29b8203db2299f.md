---
title: 'Jestã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’Github Actionsã§PRã«è‡ªå‹•ã‚³ãƒ¡ãƒ³ãƒˆ'
emoji: 'ğŸˆ'
type: 'tech'
topics: ['githubactions', 'jest', 'tdd', 'ãƒ†ã‚¹ãƒˆ', 'ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸']
published: true
---

ã“ã¡ã‚‰ã¯ã€[ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ†ã‚¹ãƒˆã®å°ãƒã‚¿ Advent Calendar 2021](https://qiita.com/advent-calendar/2021/software-testing-koneta) ã§æ›¸ã„ãŸè¨˜äº‹ã§ã™ã€‚

# [jest coverage report action](https://github.com/ArtiomTr/jest-coverage-report-action)

> A GitHub action that reports about your code coverage in every pull request.

Github Actions ã§ Jest ã® coverage report ã‚’ PR ã«ç¶ºéº—ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã‚Œã‚‹
â†“ ã“ã‚“ãªæ„Ÿã˜ã§ã‚³ãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹ (`jest-coverage-report-action` ã® README ã‚ˆã‚Š) ![](https://storage.googleapis.com/zenn-user-upload/b0999d6ab005-20211203.png)

## å‰æ

- npm version 7 ä»¥ä¸Š ( yarn ã§ã‚‚å¯èƒ½)
- Jest ã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
- Github Actions ã‚’ä½¿ã†
- jest-coverage-report-action v2.0-rc.6

### `jest-coverage-report-action` ã‚’é¸ã‚“ã æ™‚ã®æ°—æŒã¡ (â€»ã“ã‚Œã¯ãƒ•ã‚§ãƒ¼ã‚ºã‚„ãƒãƒ¼ãƒ ãã‚Œãã‚Œã§ã™...!)

- ãƒ†ã‚¹ãƒˆã‚’é ‘å¼µã£ã¦ãŸãã•ã‚“æ›¸ã„ã¦ã„ã‚‹ã®ã§ã€PR ã”ã¨ã«ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’è¦‹ã¦ãƒ†ã‚¹ãƒˆã‚’æ›¸ããƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¶­æŒã—ãŸã„
- æ•°äººã®å°‘äººæ•°ãƒãƒ¼ãƒ ã§ã‚µãƒ¼ãƒ“ã‚¹é–‹ç™ºåˆæœŸæ®µéšã®ãŸã‚ã€ã‚«ãƒãƒ¬ãƒƒã‚¸æŒ‡æ¨™ã‚’æ°—ã«ã—éãã‚‹ã“ã¨ã¯ã¾ã ã—ãŸããªã„(XX%ä»¥ä¸Šã˜ã‚ƒãªã‘ã‚Œã° PR merge ã—ãªã„! ã¿ãŸã„ãªãƒ«ãƒ¼ãƒ«ã¯ã¾ã ç„¡ã„)
- ãƒ†ã‚¹ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯äººåŠ›ã§ã¯é›£ã—ã„ã€‚æŠœã‘ã¯ã‚ã‚‹ã®ã§ã€æ•°å€¤åŒ–ã—ã¦ãªã‚“ã¨ãªãã®æŠŠæ¡ã¯ã—ã¦ãŠããŸã„
- local ã§ `jest --coverage` ã‚³ãƒãƒ³ãƒ‰ã ã¨ coverage report ã¯ç”Ÿæˆã•ã‚Œã‚‹ã‘ã©ã€ã„ã¡ã„ã¡ã‚³ãƒãƒ³ãƒ‰æ‰“ã¤ã®ãŒé¢å€’ã ã—ã€ãƒãƒ¼ãƒ ã®ä»–ã®äººã«å…±æœ‰ã—ã¥ã‚‰ã„
- Github Actions ã§ coverage report ã®æ•°å€¤ã‚’ PR ã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã®ã‚’è‡ªåˆ†ã§å®Ÿè£…ã—ã¦ã‚‚ã„ã„ã‘ã©é¢å€’

## ãªãœã“ã‚Œã‚’æ›¸ãã®ã‹ï¼Ÿ

README è¦‹ã‚Œã°ä¸€ç™ºã˜ã‚ƒã‚“...ã£ã¦æ€ã„ã¾ã™ã‚ˆã­ã€ç§ã‚‚æ€ã£ã¦ã„ã¾ã—ãŸãŒã€ã¡ã‚‡ã£ã¨è©°ã¾ã£ã¦ã—ã¾ã£ãŸãŸã‚ã€æ›¸ãã¾ã™ã€‚
`jest-coverage-report-action` ã‚’ä½¿ã„ãŸã„ãªã¨æ€ã£ãŸæ–¹ã¯ã€ãœã²ã“ã¡ã‚‰ã‚’è¦‹ã¦ã‚ˆã‹ã£ãŸã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚

# [README](https://github.com/ArtiomTr/jest-coverage-report-action#usage) é€šã‚Šã«ã¾ãšã¯è¨­å®šã—ã¦ã¿ãŸ

## .github/workflows ã§ã®æœ€å°è¨­å®š

[README](https://github.com/ArtiomTr/jest-coverage-report-action#usage) ã«ã€æœ€å°è¨­å®šã¯ã“ã†ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ (2021 å¹´ 12 æœˆç¾åœ¨)

```yml:.github/workflows
name: 'coverage'
on:
    pull_request:
        branches:
            - master
            - main
jobs:
    coverage:
        runs-on: ubuntu-latest
        if: "!contains(github.event.head_commit.message, '[skip ci]')"
        steps:
            - uses: actions/checkout@v1
            - uses: ArtiomTr/jest-coverage-report-action@v2.0-rc.6
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  #   threshold: 80 # optional parameter
```

## å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºè¨­å®šã—ãŸã„å ´åˆ

### [Customizing test script](https://github.com/ArtiomTr/jest-coverage-report-action#customizing-test-script)

ä¾‹ãˆã°ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã•ã›ã‚‹ã¨ã—ã¾ã™ã€‚
ï¼ˆâ€»ã“ã‚Œã¯é–“é•ã£ã¦ã¾ã™. ã“ã®ã¾ã¾ã‚„ã£ã¦ã‚‚å‹•ãã¾ã›ã‚“ (å¾Œè¿°))

```json:package.json
"script": {
    npx jest --silent --ci --coverage --coverageReporters="text" --coverageReporters="text-summary"
}
```

#### .github/workflows ã® yml file ã« `test-script` option ã‚’è¿½åŠ ã™ã‚‹

```yml:.github/workflows
- uses: ArtiomTr/jest-coverage-report-action@v2.0-rc.6
  with:
      github-token: ${{ secrets.GITHUB_TOKEN }}
      test-script: npm run coverage:ci
```

ã‚ˆã—ï¼ã“ã‚Œã§è©¦ãã†ï¼å‹•ããã†!ã¨ãŠã‚‚ã£ãŸã‚‰ã€

### ã“ã‚Œã§å‹•ã‹ãªã„ã‚ˆãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»

å°‘ã—ãƒãƒã‚‹
ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡

# README ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã€ [Customizing test script](github.com/marketplace/actions/jest-coverage-report#customizing-test-script) ã¯é–“é•ã£ã¦ã„ã¦ã§ããªã‹ã£ãŸ

ã“ã‚ŒãŒã†ã¾ãã„ã‹ãªã„ã€‚

```json:package.json
"script": {
   npx jest --silent --ci --coverage --coverageReporters="text" --coverageReporters="text-summary"
}
```

åŒã˜ãã§ããªã‹ã£ãŸã¨è¨€ã£ã¦ã„ã‚‹æ–¹ã®ãƒ–ãƒ­ã‚°ã‚’ç™ºè¦‹ã—ã¾ã—ãŸã€‚

https://oikawa.dev/posts/20210810_jest-coverage-report-action

> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å‚è€ƒã« test-script ã‚’æ›¸ã„ã¦ã—ã¾ã†ã¨å‹•ãã¾ã›ã‚“ã€‚

ãƒŠãƒ«ãƒ›ãƒ‰ã€‚ã€‚ã€‚

ã˜ã‚ƒã‚ã€jest-coverage-report-action è‡ªä½“ã¯ã“ã‚Œã‚’ã©ã†ã‚„ã£ã¦å®Ÿè¡Œã—ã¦ã‚“ã®ï¼Ÿï¼Ÿ

ã¨ã„ã†ã“ã¨ã§ã€`jest-coverage-report-action` è‡ªä½“ã® [./github/workflows/test.yml](https://github.com/ArtiomTr/jest-coverage-report-action/blob/master/.github/workflows/test.yml) ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### `jest-coverage-report-action` ã® [./github/workflows/test.yml](https://github.com/ArtiomTr/jest-coverage-report-action/blob/master/.github/workflows/test.yml)

```yml:.github/workflows/test.yml
jobs:
    coverage:
        runs-on: ubuntu-latest
        name: Coverage report
        steps:
            - name: Checkout
              uses: actions/checkout@v2
            - name: Test coverage
              uses: ./ # Uses an action in the root directory
              with:
                  github-token: ${{ secrets.BOT_TOKEN }}
                  annotations: failed-tests
                  test-script: npm run test:coverage
```

`npm run test:coverage` ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚

`test:coverage` ã¯ãƒŠãƒ‹ã‹ãªã€œã¨ã„ã†ã“ã¨ã§ã€[package.json](ArtiomTr/jest-coverage-report-action@master/package.json#L10) ã‚’è¦‹ã¦ã‚„ã‚Šã¾ã™

### `jest-coverage-report-action` ã® [package.json](ArtiomTr/jest-coverage-report-action@master/package.json#L10) scripts

```json:package.json
"scripts": {
  "test": "jest",
  "test:log-coverage": "jest --coverage",
  "test:coverage": "jest --silent --testLocationInResults --ci --all --coverage --json --outputFile=\"report.json\"",
},
```

ã«ãªã£ã¦ã‚‹ï¼ˆ ğŸ˜‡ ã‡? Customizing test script ã®ã¨å…¨ç„¶é•ã† yann...ï¼‰

`jest-coverage-report-action` ã® [./github/workflows/test.yml](https://github.com/ArtiomTr/jest-coverage-report-action/blob/master/.github/workflows/test.yml) ã‚’çœŸä¼¼ã—ã¦ã€ã“ã†è¨­å®šã—ã¦ã¿ã¾ã™ã€‚

```json
"scripts": {
  "test": "jest",
  "test:coverage": "npm run test -- --coverage --silent --testLocationInResults --ci --json --outputFile=\"report.json\"",
}
```

#### => å‹•ã„ãŸ ğŸ‰

# çµæœçš„ã«ã“ã®è¨­å®šã«ãªã‚Šã¾ã—ãŸ

```json:package.json
"scripts": {
    "test": "jest",
    "test:coverage": "npm run test -- --coverage --silent --testLocationInResults --ci --json --outputFile=\"report.json\""
}
```

```yml:.github/workflows/test.yml
steps:
     uses: ArtiomTr/jest-coverage-report-action@v2.0-rc.6
     with:
         github-token: ${{ secrets.GITHUB_TOKEN }}
         test-script: npm run test:coverage
```

# Tips

## yarn ã‚’ä½¿ã†å ´åˆ

yarn ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯ã€`package-manager` option ã§ `yarn` ã‚’æŒ‡å®šã™ã‚Œã°ã„ã„ãã†ã§ã™ã€‚
default ã§ã¯ `npm` ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

```yml:.github/workflows/test.yml
steps:
     uses: ArtiomTr/jest-coverage-report-action@v2.0-rc.6
     with:
         github-token: ${{ secrets.GITHUB_TOKEN }}
	 package-manager: 'yarn'    // ã“ã® option ã‚’è¨˜è¿°
         test-script: npm run test:coverage
```

## coverage æ•°å€¤ãŒ `XX%` ä»¥ä¸‹ã®å ´åˆã¯ PR ã‚’ reject ã—ãŸã„å ´åˆ

`threshold` option ã‚’æä¾›ã—ã¦ãã‚Œã¦ã„ã¦ã€%ã§æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™

```yml:.github/workflows/test.yml
steps:
     uses: ArtiomTr/jest-coverage-report-action@v2.0-rc.6
     with:
         github-token: ${{ secrets.GITHUB_TOKEN }}
         test-script: npm run test:coverage
	 threshold: 80 # 'Coverage threshold. If total coverage is less than threshold 80%, PR will be rejected'
```

ä»–ã«ã‚‚æä¾›ã•ã‚Œã¦ã„ã‚‹ option ã¯[ã“ã¡ã‚‰](https://github.com/ArtiomTr/jest-coverage-report-action/blob/master/action.yml)

## ci ã‚’ skip ã—ãŸã„æ™‚

README ã®ã“ã¡ã‚‰ã®æœ€å°æ§‹æˆã¨ã—ã¦ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ã€

```yml:.github/workflows
jobs:
    coverage:
        runs-on: ubuntu-latest
        if: "!contains(github.event.head_commit.message, '[skip ci]')"
        steps:
            - uses: actions/checkout@v1
            - uses: ArtiomTr/jest-coverage-report-action@v2.0-rc.6
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
```

ã“ã® 1 æ–‡ã¯æ›¸ã‹ãªãã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ï¼ˆä»¥å‰ã¯å¿…è¦ã ã£ãŸï¼‰

```yml
if: "!contains(github.event.head_commit.message, '[skip ci]')"
```

ã‚„ã£ã¦ã‚‹ã“ã¨ã¨ã—ã¦ã¯ã€commit message ã« `[skip ci]` ã¨æã„ã¦ã„ã‚‹å ´åˆã¯ã€steps ã‚’å®Ÿè¡Œã—ãªã„ã¨ã„ã†ã“ã¨ãªã®ã§ã™ãŒã€
ç¾åœ¨ã¯è¨˜è¼‰ã—ãªãã¦ã‚‚ã€`[skip ci], [ci skip], [no ci], [skip actions], or [actions skip]` ã®ã©ã‚Œã‹ã‚’æ›¸ã„ã¦ã„ã‚Œã°ã€ci ãŒå‹æ‰‹ã« skip ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã¾ã™(ä¾¿åˆ©!)

https://github.blog/changelog/2021-02-08-github-actions-skip-pull-request-and-push-workflows-with-skip-ci/

## ã¡ãªã¿ã«

### npm version 6 ãŒ support ã•ã‚Œã¦ã„ãªã„. version 7 ä»¥ä¸ŠãŒå¿…è¦ã§ã—ãŸ

npm version 6 ã‚’ä½¿ã£ã¦ã„ãŸã®ã§ã™ãŒã€6 ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãªã„ã½ãã¦ã€`jest-coverage-report` ãŒä½¿ãˆã¾ã›ã‚“ã§ã—ãŸã€‚
ã“ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

> npm ERR! notsup Unsupported engine
> wanted: {"node":"^14.17","npm":"^7.11"} (current: {"node":"14.18.1","npm":"6.14.15"})
